{% extends "layout.html" %}
{% block title %}GenreVision{% endblock %}
{% block extraheader %}
<style>

#sv01Slider .slider-selection {
	background: #BABABA;
}

</style>
{% endblock %}
{% block body %}
	<h1>GenreVision</h1>
	
	<div id="chart"></div>
	
	<ul id="sliders"></ul>
{% endblock %}

{% block afterboxy %}

<script type='text/javascript' src="{{ url_for('static', filename='js/d3.min.js') }}"></script>
<script type='text/javascript' src="{{ url_for('static', filename='js/bootstrap-slider.min.js') }}"></script>

<script type='text/javascript'>
	
	function debounce(fn, delay) {
	  var timer = null;
	  return function () {
		var context = this, args = arguments;
		clearTimeout(timer);
		timer = setTimeout(function () {
		  fn.apply(context, args);
		}, delay);
	  };
	}
	
	// width and height of canvas
	var w = 1000;
	var h = 400;
	
	var wpadding=0.20;
	var hpadding=0.20;
	
	var slider_vals = [];
	
	$(document).ready(function() {
		
		var labels = [
			'Dimension 1',
			'Dimension 2',
			'Dimension 3',
			'Dimension 4',
			'Dimension 5'
		];
		
		for (s=0; s < 5; s++) {
				$('#sliders').append("<li>"+labels[s]+": <input id='#sv"+s+"' class='sliderin' data-slider-id='svSlider' type='text' data-slider-min='0' data-slider-max='1' data-slider-step='0.0001' data-slider-value='0'/></li>");
		}

		function UpdateView(event){
									
			$.ajax({
			url: '{{ url_for('recommend_searchnear_json',_external=True) }}', 
			method: "POST",
			data: { x0 : slider_vals[0].getValue(),x1 : slider_vals[1].getValue(), x2 : slider_vals[2].getValue(),x3 : slider_vals[3].getValue(),x4 : slider_vals[4].getValue(),},
			success: function(data) {
			  
			var data = $.parseJSON( data );
			  			
			var w = 1000;
			var h = 400;
			
			var wpadding=0.20;
			var hpadding=0.20;
			
			var x=xmin=xmax=data[0][0];
			var y=ymin=ymax=data[0][1];

			for (i = 1; i < data.length; i++) {
				x=data[i][0];
				y=data[i][1];
				
				if(x<xmin) xmin=x;
				if(x>xmax) xmax=x;
				
				if(y>ymax) ymax=y;
				if(y<ymin) ymin=y;				
			}

			
			for (i = 0; i < data.length; i++) {
				data[i][0]=w*wpadding+(data[i][0]-xmin)*w*(1-2*wpadding)/(xmax-xmin);
				data[i][1]=h*hpadding+(data[i][1]-ymin)*h*(1-2*hpadding)/(ymax-ymin);
			}
			  
			svg.remove();
			svg = d3.select("#chart")
				.append("svg")
				.attr("width", w)
				.attr("height", h);
			
			svg.selectAll("circle").data(data)
				.enter()
				.append("circle")
			   .attr("cx", function(d) {
					return d[0];
			   })
			   .attr("cy", function(d) {
					return d[1];
			   })
			   .attr("r", 5);
				
			svg.selectAll("text")
			   .data(data)
			   .enter()
			   .append("text")
			   .text(function(d) {
			   		return d[2];
			   })
			   .attr("x", function(d) {
			   		return d[0];
			   })
			   .attr("y", function(d) {
			   		return d[1];
			   })
			   .attr("font-family", "sans-serif")
			   .attr("font-size", "22px")
			   .attr("fill", "blue");
			  
			},
			complete: function() {}
		  });		

			
		}
			
		$('.sliderin').each(function(s){	
			$(this).slider({
				formatter: function(value) {
					return 'Current value: ' + value;
				}
			});	
			
			slider_vals.push($(this).slider().on('slide',debounce(UpdateView,1000)).data('slider'));
		
		});


		//Create SVG element
		var svg = d3.select("#chart")
			.append("svg")
			.attr("width", w)
			.attr("height", h);

		UpdateView();

	});
</script>
{% endblock %}

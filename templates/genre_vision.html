{% extends "layout.html" %}
{% block title %}GenreVision{% endblock %}
{% block extraheader %}
<style>

#sv01Slider .slider-selection {
	background: #BABABA;
}

</style>
{% endblock %}
{% block body %}
	<h1>GenreVision</h1>
	

    <div id="chart"></div>
  
	<div class="panel panel-default">
	<div class="panel-body">
		<ul id="sliders"></ul>
		
		<div class="input-group">
		  <input id="searchbox" type="text" class="form-control" placeholder="Artist name" aria-describedby="basic-addon1">
		</div>
	
	</div>
	</div>

{% endblock %}

{% block afterboxy %}

<script type='text/javascript' src="{{ url_for('static', filename='js/d3.min.js') }}"></script>
<script type='text/javascript' src="{{ url_for('static', filename='js/bootstrap-slider.min.js') }}"></script>

<script type='text/javascript'>
	
	function debounce(fn, delay) {
	  var timer = null;
	  return function () {
		var context = this, args = arguments;
		clearTimeout(timer);
		timer = setTimeout(function () {
		  fn.apply(context, args);
		}, delay);
	  };
	}
	
	// width and height of canvas
	var w = 1000;
	var h = 400;
	
	var wpadding=0.20;
	var hpadding=0.20;
	
	var slider_vals = [];
	
	//Create SVG element
	var svg = d3.select("#chart")
		.append("svg")
		.attr("width", w)
		.attr("height", h);

	
	function setSlidersTo(point){
			for (s = 0; s < point.length; s++) {
				slider_vals[s].setValue(point[s]);
			}
				
	}
	
	function areaToRadiusMap(area){
		return (Math.sqrt((0.15+(1-area)) *800/Math.PI)) ;
	}
		
	function areaToFontSizeMap(area){
		s=Math.round( (Math.sqrt((0.1+(1-area)) *4000/Math.PI))) +'px'
		return s ;
	}
	
	function UpdateView(event){
									
			Pace.track($.ajax({
			url: '{{ url_for('recommend_searchnear_json',_external=True) }}', 
			method: "POST",
			data: { x0 : slider_vals[0].getValue(),x1 : slider_vals[1].getValue(), x2 : slider_vals[2].getValue(),x3 : slider_vals[3].getValue(),x4 : slider_vals[4].getValue(),},
			success: function(data) {
			  
			var data = $.parseJSON( data );
			  			
			var w = 1000;
			var h = 400;
			
			var wpadding=0.20;
			var hpadding=0.20;
			
			
			for (i = 0; i < data.length; i++) {
					data[i][8]=data[i][0];
					data[i][9]=data[i][1];
			}
			
			var x=xmin=xmax=data[0][8];
			var y=ymin=ymax=data[0][9];


			for (i = 1; i < data.length; i++) {
				x=data[i][8];
				y=data[i][9];
				
				if(x<xmin) xmin=x;
				if(x>xmax) xmax=x;
				
				if(y>ymax) ymax=y;
				if(y<ymin) ymin=y;				
			}

			
			for (i = 0; i < data.length; i++) {
				data[i][8]=w*wpadding+(data[i][8]-xmin)*w*(1-2*wpadding)/(xmax-xmin);
				data[i][9]=h*hpadding+(data[i][9]-ymin)*h*(1-2*hpadding)/(ymax-ymin);
			}
			  
			svg.remove();
			svg = d3.select("#chart")
				.append("svg")
				.attr("width", w)
				.attr("height", h);
			
			svg.selectAll("circle").data(data)
				.enter()
				.append("circle")
			   .attr("cx", function(d) {
					return d[8];
			   })
			   .attr("cy", function(d) {
					return d[9];
			   })
			   .attr("r", function(d){
					//return (Math.sqrt((9*d[6]+1) *4/Math.PI));
					return areaToRadiusMap(d[6]) ;
				})
				.attr("fill", "#4a90d9")
				.on("click",function(d) { 
				   setSlidersTo([d[0],d[1],d[2],d[3],d[4]]);
				   UpdateView();
				  });
				
			svg.selectAll("text")
			   .data(data)
			   .enter()
			   .append("text")
			   .text(function(d) {
			   		return d[5];
			   })
			   .attr("x", function(d) {
			   		return d[8]+areaToRadiusMap(d[6])+5;
			   })
			   .attr("y", function(d) {
			   		return d[9];
			   })
			   .attr("font-family", "sans-serif")
			   .style("font-size",function(d) { return areaToFontSizeMap(d[6])})
			   .attr("fill", "#072544")
			   .on("click",function(d) { 
				   setSlidersTo([d[0],d[1],d[2],d[3],d[4]]);
				   UpdateView();
				  });
			  
			},
			complete: function() {}
		  })
		  );
	  }		


	$( "#searchbox" ).keyup(debounce(function( event ) {
			
			$.ajax({
				url: '{{ url_for('search_artist_id_lookup_soundslike',_external=True) }}', 
				method: "POST",
				data: {search_term: $('#searchbox').val()},
				success: function(data) {
					
						var artist_id=$.parseJSON( data );
					
					
								$.ajax({
										url: '{{ url_for('get_location_from_id_json',_external=True) }}', 
									method: "POST",
									data: {aid: (artist_id[0]).toString()},
									success: function(data) {
											var searchpoint = $.parseJSON(data)
											
											console.log(searchpoint);
											setSlidersTo(searchpoint);
											
											UpdateView();
											
										}
									});
					
					
				}
			});
	},500));
	
	
	
	
	
	
	
	$(document).ready(function() {
		
		var labels = [
			'Dimension 1',
			'Dimension 2',
			'Dimension 3',
			'Dimension 4',
			'Dimension 5'
		];
		
		for (s=0; s < 5; s++) {
				$('#sliders').append("<li>"+labels[s]+": <input id='#sv"+s+"' class='sliderin' data-slider-id='svSlider' type='text' data-slider-min='0' data-slider-max='1' data-slider-step='0.0001' data-slider-value='0'/></li>");
		}




			
		$('.sliderin').each(function(s){	
			$(this).slider({
				formatter: function(value) {
					return 'Current value: ' + value;
				}
			});	
			
			slider_vals.push($(this).slider().on('slide',debounce(UpdateView,100)).data('slider'));
		
		});



		setSlidersTo([{{ initial_point|join(', ') }}])

		UpdateView();
		

 

	});
</script>
{% endblock %}
